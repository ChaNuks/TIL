# 트랜잭션(Transaction)

## 트랜잭션(Transaction)이란?
- DB에서 수행되는 일련의 작업을 하나의 논리적 단위로 묶는 개념
- 트랜잭션은 **원자성(Atomicity)**, **일관성(Consistency)**, **격리성(Isolation)**, **지속성(Durability)** 의 4가지 특성을 가짐
- 트랜잭션은 데이터베이스의 상태를 변경하는 작업을 포함하며, 이 작업들은 모두 성공하거나 모두 실패해야 함

--- 

## 트랜잭션의 4가지 특성 (ACID)
### 1. 원자성(Atomicity)
- 트랜잭션 내의 모든 작업이 성공적으로 완료되거나, 실패 시에는 모든 작업이 취소되어야 함
- 즉, 트랜잭션은 **완전한 단위**로 처리되어야 하며, 중간 상태는 존재하지 않음
- 예를 들어, 은행 계좌 이체 시 출금과 입금 작업이 모두 성공해야만 트랜잭션이 완료됨
- 만약 출금 작업이 성공했지만 입금 작업이 실패하면, 출금 작업도 취소되어야 함

### 2. 일관성(Consistency)
- 트랜잭션이 완료되면 데이터베이스는 일관된 상태를 유지해야 함
- 즉, 트랜잭션이 시작되기 전과 후의 데이터베이스 상태가 일관되어야 함
- 예를 들어, 은행 계좌 이체 시 출금과 입금 작업이 모두 성공하면, 두 계좌의 잔액이 올바르게 업데이트되어야 함
- 트랜잭션이 실패하면 데이터베이스는 이전 상태로 되돌아가야 함
- 즉, 트랜잭션이 완료되기 전과 후의 데이터베이스 상태가 일관되어야 함

### 3. 격리성(Isolation)
- 트랜잭션은 서로 독립적으로 실행되어야 하며, 동시에 실행되는 트랜잭션 간의 간섭을 방지해야 함
- 즉, 하나의 트랜잭션이 다른 트랜잭션의 작업에 영향을 미치지 않아야 함
- 예를 들어, 두 개의 트랜잭션이 동시에 실행될 때, 하나의 트랜잭션이 다른 트랜잭션의 데이터를 읽거나 수정하는 것을 방지해야 함
- 이를 위해 데이터베이스는 **잠금(Locking)** 메커니즘을 사용하여 트랜잭션 간의 간섭을 최소화함
- 트랜잭션 격리 수준(예: READ COMMITTED, REPEATABLE READ 등)을 설정하여 트랜잭션 간의 격리성을 조절할 수 있음

### 4. 지속성(Durability)
- 트랜잭션이 성공적으로 완료되면, 그 결과는 영구적으로 데이터베이스에 저장되어야 함
- 즉, 트랜잭션이 완료된 후에도 데이터베이스는 해당 작업의 결과를 유지해야 함
- 예를 들어, 은행 계좌 이체 시 출금과 입금 작업이 모두 성공하면, 해당 작업의 결과는 데이터베이스에 영구적으로 저장되어야 함
- 데이터베이스는 **로그(Log)**를 사용하여 트랜잭션의 결과를 기록하고, 시스템 장애 발생 시에도 데이터의 일관성을 유지할 수 있도록 함
- 트랜잭션이 완료된 후에도 데이터베이스는 해당 작업의 결과를 유지해야 함

---

## 트랜잭션의 상태
| 상태          | 설명                                                         |
|---------------|--------------------------------------------------------------|
| 시작(Active)  | 트랜잭션이 시작된 상태로, 작업을 수행 중인 상태               |
| 커밋(Committed) | 트랜잭션이 성공적으로 완료되어 데이터베이스에 반영된 상태     |
| 롤백(Rolled Back) | 트랜잭션이 실패하여 모든 작업이 취소된 상태                   |
| 완료(Completed) | 트랜잭션이 커밋 또는 롤백 후 종료된 상태                       |
| 실패(Failed)   | 트랜잭션이 오류로 인해 중단된 상태                             |

---

## 트랜잭션의 종류
| 종류          | 설명                                                         |
|---------------|--------------------------------------------------------------|
| 단일 트랜잭션(Single Transaction) | 하나의 데이터베이스 작업을 포함하는 트랜잭션                   |
| 분산 트랜잭션(Distributed Transaction) | 여러 데이터베이스 또는 시스템에 걸쳐 수행되는 트랜잭션           |
| 중첩 트랜잭션(Nested Transaction) | 트랜잭션 내에서 또 다른 트랜잭션을 포함하는 구조                   |
| 장기 트랜잭션(Long-Lived Transaction) | 오랜 시간 동안 실행되는 트랜잭션, 예: 대규모 데이터 처리 작업 |
| 자동 트랜잭션(Automatic Transaction) | 데이터베이스 시스템이 자동으로 관리하는 트랜잭션                   |

---

## 트랜잭션 관리
- 데이터베이스 시스템에서 트랜잭션의 시작, 커밋, 롤백 등을 관리하는 기능
- 데이터베이스의 일관성과 무결성을 유지하기 위해 필수적
- 데이터베이스 관리 시스템(DBMS)에서 제공하는 기능으로, 개발자는 이를 통해 트랜잭션을 제어할 수 있음
- 트랜잭션 관리 API를 사용하여 트랜잭션을 시작하고, 커밋하거나 롤백할 수 있음

--- 

## 트랜잭션 예제
```java
import javax.persistence.EntityManager;
import javax.persistence.EntityTransaction;
import javax.persistence.PersistenceContext;
import org.springframework.stereotype.Service;
@Service
public class UserService {
    @PersistenceContext
    private EntityManager entityManager;

    public void createUser(User user) {
        EntityTransaction transaction = entityManager.getTransaction();
        try {
            transaction.begin(); // 트랜잭션 시작
            entityManager.persist(user); // 사용자 엔티티 저장
            transaction.commit(); // 트랜잭션 커밋
        } catch (Exception e) {
            transaction.rollback(); // 예외 발생 시 트랜잭션 롤백
            throw e; // 예외 재발생
        }
    }
}
```